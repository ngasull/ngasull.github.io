{"pageProps":{"locale":"fr","scope":{"date":"2020-09-01","slug":"gerer-ses-permissions-avec-docker","lang":"fr","title":"GÃ©rer ses permissions avec Docker","html":"<section id=\"preamble\" aria-label=\"Preamble\"><p>Tout dâ€™abord soyons dâ€™accord sur les mots :</p>\n<div class=\"ulist\"><ul><li>L'<strong><em>hÃ´te</em></strong> est le systÃ¨me dâ€™exploitation de la machine, celui qui fait tourner Docker lui-mÃªme</li><li>Nous utiliserons <strong><em>conteneur</em></strong> pour se rÃ©fÃ©rer Ã  ce qui est exÃ©cutÃ© dans lâ€™univers de Docker</li><li>Les <strong><em>user namespaces</em></strong>, que jâ€™appellerai <strong><em>subuids</em></strong>, sont une fonctionnalitÃ© native Unix pour faire correspondre les ids dâ€™utilisateurs systÃ¨me vers une page dâ€™utilisateurs donnÃ©e.</li></ul></div>\n<p>Lâ€™article dÃ©crit comment utiliser les user namespaces (<em>subuids</em>) dans un environnement Unix pour rÃ©server une plage dâ€™utilisateurs au daemon Docker. Il est probable que Docker for Mac supporte cette fonctionnalitÃ©.</p></section><nav id=\"toc\" class=\"toc\" role=\"doc-toc\"><h2 id=\"toc-title\">Table des matiÃ¨res</h2><ol class=\"toc-list level-1\"><li><a href=\"#_motivation\">Motivation</a></li><li><a href=\"#_mise_en_place\">Mise en place</a><ol class=\"toc-list level-2\"><li><a href=\"#_mappings_de_dev\">Mappings de dev</a></li><li><a href=\"#_mappings_de_ciproduction\">Mappings de CI/production</a></li></ol></li><li><a href=\"#_problÃ¨mes_et_trucs_Ã _savoir\">ProblÃ¨mes et trucs Ã  savoir</a></li></ol></nav>\n<section class=\"doc-section level-1\"><h2 id=\"_motivation\">Motivation</h2><p>Sur lâ€™hÃ´te, sans configuration donnÃ©e, les fichiers manipulÃ©s par Docker appartiennent au mÃªme utilisateur que celui du conteneur. Ce nâ€™est pas rassurant dans le sens oÃ¹ le daemon Docker tourne en <code>root</code> par dÃ©faut et que les conteneurs ne sont pas tenus de sâ€™exÃ©cuter en tant que lâ€™utilisateur qui leur a Ã©tÃ© donnÃ© en configuration.</p>\n<figure class=\"example-block\"><figcaption>Exemple :</figcaption>\n<div class=\"example\">Les images <code>postgres</code> et <code>mysql</code> Ã©crivent dâ€™elles-mÃªmes une partie de leurs fichiers avec les les utilisateurs de PostgreSQL et MySQL.</div></figure>\n<p>Pour Ã©viter ce problÃ¨me, nous allons indiquer au daemon Docker Ã  quels utilisateurs hÃ´te correspondent tous les utilisateurs des conteneurs.</p></section>\n<section class=\"doc-section level-1\"><h2 id=\"_mise_en_place\">Mise en place</h2><h5 id=\"_configuration_hÃ´te_impactÃ©e\" class=\"discrete\">Configuration hÃ´te impactÃ©e :</h5>\n<div class=\"ulist\"><ul><li><code>/etc/subuid</code> - configuration des mappings utilisateur hÃ´te â‡â‡’ conteneur</li><li><code>/etc/subgid</code> - configuration des mappings groupe hÃ´te â‡â‡’ conteneur</li><li><code>/etc/docker/daemon.json</code> - configuration du daemon Docker</li></ul></div>\n<p>Selon moi, câ€™est avantageux de configurer diffÃ©remment ces mappings sur les machines des dÃ©veloppeurs et en CI/production. En effet : autant tirer profit de cette flexibilitÃ© pour dÃ©velopper confortablement tout en gardant la production sous contrÃ´le.</p>\n<section class=\"doc-section level-2\"><h3 id=\"_mappings_de_dev\">Mappings de dev</h3><p>En mappant le <code>root</code> des conteneurs vers ton utilisateur hÃ´te, tu peux simplement profiter dâ€™une transparence de permissions par dÃ©faut. Plus de problÃ¨mes avec les volumes gÃ©nÃ©rÃ©s en <code>root</code> hÃ´te puis crashant lâ€™exÃ©cution Ã  cause de la mauvaise permission !</p>\n<p>Pour ma part, je map simplement <code>root</code> vers mon user hÃ´te puis tous les autres uids 1+ vers 100001+ sur lâ€™hÃ´te.</p>\n<p>La seule chose Ã  confirmer : lâ€™id de ton utilisateur hÃ´te. Câ€™est souvent 1000 et câ€™est vÃ©rifiable en exÃ©cutant <code>id -u</code>.</p>\n<h5 id=\"_etcsubuid\" class=\"discrete\">/etc/subuid</h5>\n<div class=\"listing-block\"><pre class=\"highlightjs highlight\"><code class=\"language-none hljs\">dockremap:1000:1\ndockremap:100001:65536</code></pre></div>\n<h5 id=\"_explication\" class=\"discrete\">Explication</h5>\n<p>Un mapping nommÃ© <code>dockremap</code> est crÃ©Ã© :</p>\n<div class=\"ulist\"><ul><li><em>1e ligne :</em> assigne 1 utilisateur (de conteneur pour nous) vers lâ€™uid 1000. Ce 1e utilisateur est lâ€™utilisateur 0, donc <code>root</code>.</li><li><em>2e ligne :</em> assigne les 65536 prochains utilisateurs vers la plage commenÃ§ant par 100001, donc vers 100001-165536. Par exemple, lâ€™utilisateur conteneur 66 sera manipulÃ© sur lâ€™hÃ´te comme Ã©tant lâ€™utilisateur 100066.</li></ul></div>\n<p>Je pense quâ€™appliquer le mÃªme principe pour les groupes est tout aussi profitable : la transparence est totale. On peut vÃ©rifier son <code>gid</code> avec <code>id -g</code>.</p>\n<h5 id=\"_etcsubgid\" class=\"discrete\">/etc/subgid</h5>\n<div class=\"listing-block\"><pre class=\"highlightjs highlight\"><code class=\"language-none hljs\">dockremap:1000:1\ndockremap:100001:65536</code></pre></div>\n<h5 id=\"_etcdockerdaemon_json\" class=\"discrete\">/etc/docker/daemon.json</h5>\n<div class=\"listing-block\"><pre class=\"highlightjs highlight\"><code class=\"language-json hljs\" data-lang=\"json\"><span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">\"userns-remap\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"dockremap\"</span>\n<span class=\"hljs-punctuation\">}</span></code></pre></div>\n<p>Nâ€™oublie pas de redÃ©marrer le daemon docker pour que cela prenne effet ğŸ˜‰</p>\n<div class=\"listing-block\"><pre class=\"highlightjs highlight\"><code class=\"language-bash hljs\" data-lang=\"bash\">sudo service docker restart</code></pre></div></section>\n<section class=\"doc-section level-2\"><h3 id=\"_mappings_de_ciproduction\">Mappings de CI/production</h3><p>En production, la configuration dÃ©pend davantage des permissions que tu veux donner Ã  tes conteneurs. On est davantage sur des problÃ©matiques de sÃ©curitÃ© que de praticitÃ©.</p>\n<p>Il est possible dâ€™appliquer le mÃªme type de configuration que prÃ©cÃ©demment Ã  condition de bien connaÃ®tre les consÃ©quences du mapping, en particulier pour lâ€™utilisateur 0.</p></section></section>\n<section class=\"doc-section level-1\"><h2 id=\"_problÃ¨mes_et_trucs_Ã _savoir\">ProblÃ¨mes et trucs Ã  savoir</h2><p>Il est possible de mapper plusieurs utilisateurs spÃ©cifiques conteneur vers des utilisateurs spÃ©cifiques hÃ´te. Par exemple :</p>\n<div class=\"listing-block\"><pre class=\"highlightjs highlight\"><code class=\"language-none hljs\">dockremap:1000:1\ndockremap:100001:65\ndockremap:666:1\ndockremap:100067:65469</code></pre></div>\n<p>Ce qui peut se lire : map 0 conteneur vers 1000 hÃ´te, map les 65 utilisateurs suivants sur la plage hÃ´te commenÃ§ant par 100001, map le suivant (66) vers 666 sur lâ€™hÃ´te, map le reste sur la plage hÃ´te commenÃ§ant par 100067.</p>\n<hr>\n<p>Jâ€™espÃ¨re que cet article tâ€™aura Ã©clairÃ© sur lâ€™utilisation des <em>user namespaces</em> pour gÃ©rer ses permissions Docker. Il sâ€™agit dâ€™un retour dâ€™expÃ©rience personnelle et de mes avis sur le sujet. Nâ€™hÃ©site pas Ã  explorer par toi-mÃªme, faire ta propre configuration et <a href=\"/fr/about/\">me la partager</a> ğŸ™‚</p></section>","categories":["devops"]}},"__N_SSG":true}